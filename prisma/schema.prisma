// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
  ACCOUNTANT
}

enum StaffType {
  TEACHER
  ACCOUNTANT
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum FeeInterval {
  ONE_TIME
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum ConcessionType {
  PERCENTAGE
  FIXED
}

enum PenaltyType {
  PERCENTAGE
  FIXED
}

enum PenaltyFrequency {
  DAILY
  ONE_TIME
}

enum FeeInvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING_VERIFICATION
  COMPLETED
  FAILED
}

enum ResultStatus {
  PENDING
  PENDING_APPROVAL
  APPROVED
  PENDING_REAPPROVAL
  FINALIZED
  REJECTED
}

enum LearningMaterialType {
  VIDEO
  DOCUMENT
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_THE_BLANK
}

enum TestStatus {
  UPCOMING
  ACTIVE
  COMPLETED
}

enum TestResultVisibility {
  IMMEDIATE
  AFTER_END_TIME
}

model School {
  id              String         @id @default(cuid())
  name            String
  accountName     String         @unique
  branch          String
  contactPerson   String
  phone           String
  address         String
  logoUrl         String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  users           User[]
  academicYears   AcademicYear[]
  grades          Grade[]
  sections        Section[]
  students        Student[]
  staff           Staff[]
  parents         Parent[]
  courses         Course[]
  feeStructures   FeeStructure[]
  penaltyRules    PenaltyRule[]
  concessions     Concession[]
  feePayments     FeePayment[]
  communications  Communication[]
  learningMaterials LearningMaterial[]
  tests           Test[]
  exams           Exam[]
  liveSessions    LiveSession[]
}

model User {
  id                 String          @id @default(cuid())
  phone              String          @unique
  password           String
  role               UserRole
  firstName          String
  lastName           String
  middleName         String?
  addressLine1       String?
  city               String?
  state              String?
  zipCode            String?
  photoUrl           String?
  schoolId           String
  school             School          @relation(fields: [schoolId], references: [id])
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  staffProfile       Staff?
  studentProfile     Student?
  parentProfile      Parent?
  markedAttendance   Attendance[]    @relation("markedBy")
  sentCommunications Communication[] @relation("sent")
  receivedCommunications Communication[] @relation("received")
  uploadedMaterials  LearningMaterial[]
  assignedTests      Test[]
}

model AcademicYear {
  id          String         @id @default(cuid())
  name        String
  isCurrent   Boolean        @default(false)
  schoolId    String
  school      School         @relation(fields: [schoolId], references: [id])
  enrollments Enrollment[]
  feeInvoices FeeInvoice[]
  concessionAssignments ConcessionAssignment[]
  exams       Exam[]

  @@unique([name, schoolId])
}

model Grade {
  id           String        @id @default(cuid())
  name         String
  schoolId     String
  school       School        @relation(fields: [schoolId], references: [id])
  students     Student[]
  courses      Course[]
  tests        Test[]
  exams        Exam[]
  learningMaterials LearningMaterial[]
  liveSessions LiveSession[]
  sections     Section[]

  @@unique([name, schoolId])
}

model Section {
  id       String    @id @default(cuid())
  name     String
  schoolId String
  school   School    @relation(fields: [schoolId], references: [id])
  gradeId  String?
  grade    Grade?    @relation(fields: [gradeId], references: [id])
  students Student[]
  courses  Course[]
  tests    Test[]
  exams    Exam[]

  @@unique([name, schoolId, gradeId])
}

model Student {
  id                    String                  @id @default(cuid())
  userId                String                  @unique
  user                  User                    @relation(fields: [userId], references: [id])
  firstName             String
  lastName              String
  dob                   DateTime
  gender                Gender
  schoolId              String
  school                School                  @relation(fields: [schoolId], references: [id])
  gradeId               String
  grade                 Grade                   @relation(fields: [gradeId], references: [id])
  sectionId             String
  section               Section                 @relation(fields: [sectionId], references: [id])
  enrollments           Enrollment[]
  parents               Parent[]
  attendances           Attendance[]
  concessionAssignments ConcessionAssignment[]
  feeInvoices           FeeInvoice[]
  testSubmissions       TestSubmission[]
  examResults           ExamResult[]
  liveSessionRegistrations LiveSessionRegistration[]
  communications        Communication[]
}

model Staff {
  id         String     @id @default(cuid())
  userId     String     @unique
  user       User       @relation(fields: [userId], references: [id])
  schoolId   String
  school     School     @relation(fields: [schoolId], references: [id])
  firstName  String
  lastName   String
  staffType  StaffType
  courses    Course[]
  attendance Attendance[]
  liveSessions LiveSession[]
}

model Parent {
  id                  String     @id @default(cuid())
  userId              String     @unique
  user                User       @relation(fields: [userId], references: [id])
  schoolId            String
  school              School     @relation(fields: [schoolId], references: [id])
  firstName           String
  lastName            String
  relationToStudent   String
  students            Student[]
}

model Attendance {
  id          String           @id @default(cuid())
  studentId   String
  student     Student          @relation(fields: [studentId], references: [id])
  date        DateTime         @db.Date
  status      AttendanceStatus
  notes       String?
  markedById  String
  markedBy    User             @relation("markedBy", fields: [markedById], references: [id])

  @@unique([studentId, date])
}

model Course {
  id          String       @id @default(cuid())
  name        String
  gradeId     String
  grade       Grade        @relation(fields: [gradeId], references: [id])
  sectionId   String
  section     Section      @relation(fields: [sectionId], references: [id])
  teacherId   String
  teacher     Staff        @relation(fields: [teacherId], references: [id])
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id])
  enrollments Enrollment[]

  @@unique([name, gradeId, sectionId])
}

model Enrollment {
  id             String   @id @default(cuid())
  studentId      String
  student        Student  @relation(fields: [studentId], references: [id])
  courseId       String
  course         Course   @relation(fields: [courseId], references: [id])
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  results        Result[]

  @@unique([studentId, courseId, academicYearId])
}

model Result {
  id           String     @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  grade        String
  examType     String?
  date         DateTime   @default(now())
}

model FeeStructure {
  id            String         @id @default(cuid())
  name          String
  amount        Float
  interval      FeeInterval
  schoolId      String
  school        School         @relation(fields: [schoolId], references: [id])
  invoices      FeeInvoice[]
  penaltyRuleId String?
  penaltyRule   PenaltyRule?   @relation(fields: [penaltyRuleId], references: [id])
  concessions   Concession[]   @relation("ConcessionToFeeStructure")
}

model PenaltyRule {
  id           String         @id @default(cuid())
  name         String
  gracePeriod  Int
  schoolId     String
  school       School         @relation(fields: [schoolId], references: [id])
  feeStructures FeeStructure[]
  tiers        PenaltyTier[]
}

model PenaltyTier {
  id          String           @id @default(cuid())
  ruleId      String
  rule        PenaltyRule      @relation(fields: [ruleId], references: [id])
  fromDay     Int
  toDay       Int?
  value       Float
  type        PenaltyType
  frequency   PenaltyFrequency
}

model Concession {
  id             String               @id @default(cuid())
  name           String
  description    String?
  type           ConcessionType
  value          Float
  schoolId       String
  school         School               @relation(fields: [schoolId], references: [id])
  assignments    ConcessionAssignment[]
  feeStructures  FeeStructure[]       @relation("ConcessionToFeeStructure")
}

model ConcessionAssignment {
  id             String       @id @default(cuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  concessionId   String
  concession     Concession   @relation(fields: [concessionId], references: [id])
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  feeInvoices    FeeInvoice[]

  @@unique([studentId, concessionId, academicYearId])
}

model FeeInvoice {
  id                    String                 @id @default(cuid())
  studentId             String
  student               Student                @relation(fields: [studentId], references: [id])
  feeStructureId        String
  feeStructure          FeeStructure           @relation(fields: [feeStructureId], references: [id])
  academicYearId        String
  academicYear          AcademicYear           @relation(fields: [academicYearId], references: [id])
  amount                Float
  dueDate               DateTime
  status                FeeInvoiceStatus
  payments              FeePayment[]
  concessionAssignments ConcessionAssignment[]
}

model FeePayment {
  id          String        @id @default(cuid())
  invoiceId   String
  invoice     FeeInvoice    @relation(fields: [invoiceId], references: [id])
  amount      Float
  paymentDate DateTime
  method      String
  reference   String?
  status      PaymentStatus
  schoolId    String
  school      School        @relation(fields: [schoolId], references: [id])
}

model Communication {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  senderId    String
  sender      User     @relation("sent", fields: [senderId], references: [id])
  receiverId  String
  receiver    User     @relation("received", fields: [receiverId], references: [id])
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  subject     String
  message     String
  sentAt      DateTime @default(now())
  isRead      Boolean  @default(false)
}

model LearningMaterial {
  id          String               @id @default(cuid())
  title       String
  description String?
  subject     String
  gradeId     String
  grade       Grade                @relation(fields: [gradeId], references: [id])
  type        LearningMaterialType
  url         String?
  uploaderId  String
  uploader    User                 @relation(fields: [uploaderId], references: [id])
  schoolId    String
  school      School               @relation(fields: [schoolId], references: [id])
  createdAt   DateTime             @default(now())
}

model Question {
  id            String      @id @default(cuid())
  testId        String
  test          Test        @relation(fields: [testId], references: [id])
  text          String
  type          QuestionType
  options       String
  correctAnswer String
  points        Int
  answers       TestAnswer[]
}

model Test {
  id               String               @id @default(cuid())
  name             String
  gradeId          String
  grade            Grade                @relation(fields: [gradeId], references: [id])
  sectionId        String
  section          Section              @relation(fields: [sectionId], references: [id])
  subject          String
  teacherId        String
  teacher          User                 @relation(fields: [teacherId], references: [id])
  startTime        DateTime
  endTime          DateTime
  duration         Int
  totalMarks       Int
  isMock           Boolean
  resultVisibility TestResultVisibility
  status           TestStatus
  schoolId         String
  school           School               @relation(fields: [schoolId], references: [id])
  questions        Question[]
  submissions      TestSubmission[]
}

model TestSubmission {
  id             String     @id @default(cuid())
  testId         String
  test           Test       @relation(fields: [testId], references: [id])
  studentId      String
  student        Student    @relation(fields: [studentId], references: [id])
  submittedAt    DateTime
  score          Int
  status         String // e.g., PENDING, AWAITING_APPROVAL, GRADED
  answers        TestAnswer[]
}

model TestAnswer {
  id           String         @id @default(cuid())
  submissionId String
  submission   TestSubmission @relation(fields: [submissionId], references: [id])
  questionId   String
  question     Question       @relation(fields: [questionId], references: [id])
  answer       String
}

model Exam {
  id             String       @id @default(cuid())
  name           String
  weightage      Float
  gradingType    String
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  gradeId        String
  grade          Grade        @relation(fields: [gradeId], references: [id])
  sectionId      String
  section        Section      @relation(fields: [sectionId], references: [id])
  subject        String
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id])
  results        ExamResult[]
}

model ExamResult {
  id        String       @id @default(cuid())
  examId    String
  exam      Exam         @relation(fields: [examId], references: [id])
  studentId String
  student   Student      @relation(fields: [studentId], references: [id])
  score     String
  status    ResultStatus

  @@unique([examId, studentId])
}

model LiveSession {
  id            String                    @id @default(cuid())
  topic         String
  description   String?
  subject       String
  gradeId       String
  grade         Grade                     @relation(fields: [gradeId], references: [id])
  startTime     DateTime
  duration      Int
  fee           Float
  status        String // UPCOMING, ACTIVE, COMPLETED
  teacherId     String
  teacher       Staff                     @relation(fields: [teacherId], references: [id])
  schoolId      String
  school        School                    @relation(fields: [schoolId], references: [id])
  registrations LiveSessionRegistration[]
}

model LiveSessionRegistration {
  id            String      @id @default(cuid())
  liveSessionId String
  liveSession   LiveSession @relation(fields: [liveSessionId], references: [id])
  studentId     String
  student       Student     @relation(fields: [studentId], references: [id])
}
